<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iOS Calculator</title>
    <style>
        body { background-color: #000; display: flex; justify-content: center; align-items: flex-end; height: 100vh; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; -webkit-user-select: none; }
        .calc-container { width: 100%; max-width: 400px; padding-bottom: 40px; padding-left: 15px; padding-right: 15px; box-sizing: border-box; }
        
        /* 显示区域 */
        .display-wrapper { display: flex; flex-direction: column; align-items: flex-end; padding-right: 20px; margin-bottom: 15px; min-height: 180px; justify-content: flex-end; }
        .history-display { color: #888; font-size: 22px; min-height: 30px; margin-bottom: 10px; font-weight: 400; text-align: right; word-break: break-all; }
        .main-display { color: white; font-size: 90px; font-weight: 300; letter-spacing: -2px; line-height: 1; transition: font-size 0.2s; }

        /* 按钮通用样式 */
        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        button { border: none; border-radius: 50%; height: 80px; width: 80px; font-size: 35px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.5s ease; -webkit-tap-highlight-color: transparent; outline: none; }
        
        /* 1. 数字键反馈 */
        .num { background-color: #333333; color: white; }
        .num:active { background-color: #737373; transition: background-color 0s; } /* 瞬间变浅 */

        /* 2. 运算符反馈 */
        .op { background-color: #f1a33c; color: white; font-size: 40px; }
        .op:active { background-color: #f7cf99; transition: background-color 0s; } /* 瞬间变白亮 */

        /* 3. 特殊功能键反馈 */
        .special { background-color: #a5a5a5; color: black; font-size: 30px; }
        .special:active { background-color: #d9d9d9; transition: background-color 0s; }

        .zero { grid-column: span 2; width: auto; border-radius: 40px; justify-content: flex-start; padding-left: 32px; }
        
        /* 针对小屏幕优化 */
        @media (max-width: 380px) {
            button { height: 70px; width: 70px; font-size: 30px; }
            .main-display { font-size: 75px; }
        }
    </style>
</head>
<body>

<div class="calc-container">
    <div class="display-wrapper">
        <div class="history-display" id="history"></div>
        <div class="main-display" id="display">0</div>
    </div>
    <div class="buttons">
        <button class="special" onclick="reset()">AC</button>
        <button class="special" onclick="fakeStep()">+/-</button>
        <button class="special" onclick="fakeStep()">%</button>
        <button class="op" onclick="handleOp('÷')">÷</button>
        
        <button class="num" onclick="handleNum('7')">7</button>
        <button class="num" onclick="handleNum('8')">8</button>
        <button class="num" onclick="handleNum('9')">9</button>
        <button class="op" onclick="handleOp('×')">×</button>
        
        <button class="num" onclick="handleNum('4')">4</button>
        <button class="num" onclick="handleNum('5')">5</button>
        <button class="num" onclick="handleNum('6')">6</button>
        <button class="op" onclick="handleOp('-')">-</button>
        
        <button class="num" onclick="handleNum('1')">1</button>
        <button class="num" onclick="handleNum('2')">2</button>
        <button class="num" onclick="handleNum('3')">3</button>
        <button class="op" onclick="handleOp('+')">+</button>
        
        <button class="num zero" onclick="handleNum('0')">0</button>
        <button class="num" onclick="fakeStep()">.</button>
        <button class="op" onclick="calculate()">=</button>
    </div>
</div>

<script>
    let mainVal = "0";
    let historyVal = "";
    let firstNum = "";
    let secondNum = "";
    let targetA = "";
    let aPtr = 0;
    let isMagic = false;
    let stage = 0; // 0:输入第一数, 1:输入第二数, 2:变色龙模式

    const displayEl = document.getElementById('display');
    const historyEl = document.getElementById('history');

    function update() {
        // 主屏幕显示逻辑：数字格式化
        if (mainVal === "0") {
            displayEl.innerText = "0";
        } else {
            // 如果长度太长则不进行 LocaleString 以免截断
            let displayStr = mainVal.length > 9 ? mainVal : Number(mainVal).toLocaleString();
            displayEl.innerText = displayStr;
        }

        // 历史屏幕显示
        historyEl.innerText = historyVal;

        // 字体缩放逻辑
        if (mainVal.length > 6) {
            displayEl.style.fontSize = "50px";
        } else {
            displayEl.style.fontSize = "90px";
        }
    }

    function handleNum(n) {
        if (isMagic) {
            triggerMagicStep();
            return;
        }

        if (stage === 0) {
            mainVal = (mainVal === "0") ? n : mainVal + n;
        } else if (stage === 1) {
            mainVal = (mainVal === "0") ? n : mainVal + n;
            secondNum = mainVal;
        }
        update();
    }

    function handleOp(op) {
        if (isMagic) {
            triggerMagicStep();
            return;
        }

        // 第一阶段：输入完 4 位数按运算符
        if (stage === 0 && mainVal.length === 4) {
            firstNum = mainVal;
            historyVal = Number(firstNum).toLocaleString() + " " + op;
            mainVal = "0";
            stage = 1;
        } 
        // 关键触发：第一数已定，第二数输入 5 位后按下运算符
        else if (stage === 1 && mainVal.length === 5) {
            secondNum = mainVal;
            // 计算魔法值 A
            let A_val = 2162227 - (parseInt(firstNum) + parseInt(secondNum));
            targetA = A_val.toString();
            
            isMagic = true;
            stage = 2;
            // 按下运算符后，苹果计算器通常屏幕数字不动，但上方历史会更新
            historyVal = Number(firstNum).toLocaleString() + " + " + Number(secondNum).toLocaleString() + " " + op;
        } else {
            // 兜底正常逻辑
            historyVal = mainVal + " " + op;
            mainVal = "0";
        }
        update();
    }

    function triggerMagicStep() {
        if (aPtr < targetA.length) {
            let nextDigit = targetA[aPtr];
            
            if (aPtr === 0) {
                mainVal = nextDigit;
                // 灰色部分也同步开始显示变色龙数值
                historyVal = Number(firstNum).toLocaleString() + " + " + Number(secondNum).toLocaleString() + " + " + nextDigit;
            } else {
                mainVal += nextDigit;
                historyVal += nextDigit;
            }
            
            aPtr++;
            update();
        }
    }

    function calculate() {
        if (isMagic && aPtr >= targetA.length) {
            mainVal = "2162227";
            historyVal = ""; // 达成后清空上方
            isMagic = false;
            update();
        } else {
            // 正常的等号，在这里不做复杂逻辑，直接保持
            update();
        }
    }

    function fakeStep() {
        if (isMagic) triggerMagicStep();
    }

    function reset() {
        mainVal = "0";
        historyVal = "";
        firstNum = "";
        secondNum = "";
        targetA = "";
        aPtr = 0;
        isMagic = false;
        stage = 0;
        update();
    }
</script>

</body>
</html>

