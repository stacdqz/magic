<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Magic Calc Ultra</title>
    <style>
        body { background-color: #000; display: flex; justify-content: center; align-items: flex-end; height: 100vh; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; -webkit-user-select: none; }
        .calc-container { width: 100%; max-width: 400px; padding-bottom: 40px; padding-left: 20px; padding-right: 20px; box-sizing: border-box; }
        
        .display-wrapper { display: flex; flex-direction: column; align-items: flex-end; padding-right: 10px; margin-bottom: 15px; min-height: 160px; justify-content: flex-end; }
        .history-display { color: #888; font-size: 22px; min-height: 30px; margin-bottom: 8px; letter-spacing: 0.5px; font-weight: 400; }
        .main-display { color: white; font-size: 80px; font-weight: 300; letter-spacing: -2px; line-height: 1; transition: all 0.05s; }

        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; }
        button { border: none; border-radius: 50%; height: 75px; width: 75px; font-size: 30px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: filter 0.1s; -webkit-tap-highlight-color: transparent; }
        button:active { filter: brightness(1.5); }
        .num { background-color: #333; color: white; }
        .op { background-color: #f1a33c; color: white; font-size: 35px; }
        .special { background-color: #a5a5a5; color: black; }
        .zero { grid-column: span 2; width: auto; border-radius: 40px; justify-content: flex-start; padding-left: 30px; }
        
        @media (max-width: 380px) {
            button { height: 65px; width: 65px; }
            .main-display { font-size: 65px; }
        }
    </style>
</head>
<body>

<div class="calc-container">
    <div class="display-wrapper">
        <div class="history-display" id="history"></div>
        <div class="main-display" id="display">0</div>
    </div>
    <div class="buttons">
        <button class="special" onclick="reset()">AC</button>
        <button class="special" onclick="fakeStep()">+/-</button>
        <button class="special" onclick="fakeStep()">%</button>
        <button class="op" onclick="handleOp('÷')">÷</button>
        
        <button class="num" onclick="handleNum('7')">7</button>
        <button class="num" onclick="handleNum('8')">8</button>
        <button class="num" onclick="handleNum('9')">9</button>
        <button class="op" onclick="handleOp('×')">×</button>
        
        <button class="num" onclick="handleNum('4')">4</button>
        <button class="num" onclick="handleNum('5')">5</button>
        <button class="num" onclick="handleNum('6')">6</button>
        <button class="op" onclick="handleOp('-')">-</button>
        
        <button class="num" onclick="handleNum('1')">1</button>
        <button class="num" onclick="handleNum('2')">2</button>
        <button class="num" onclick="handleNum('3')">3</button>
        <button class="op" onclick="handleOp('+')">+</button>
        
        <button class="num zero" onclick="handleNum('0')">0</button>
        <button class="num" onclick="fakeStep()">.</button>
        <button class="op" onclick="calculate()">=</button>
    </div>
</div>

<script>
    let mainVal = "0";      // 主显示屏内容
    let historyVal = "";    // 灰色算式内容
    let firstNum = "";      // 记录第一个四位数
    let secondNum = "";     // 记录第二个五位数
    let targetA = "";       // 补差数 A
    let aPtr = 0;           // A 的索引指针
    let isMagic = false;    // 是否进入变色龙模式
    let stage = 0;          // 0:输入第一数, 1:输入第二数, 2:魔法进行中

    const displayEl = document.getElementById('display');
    const historyEl = document.getElementById('history');

    function update() {
        // 主屏幕格式化显示
        displayEl.innerText = mainVal.includes('.') ? mainVal : Number(mainVal).toLocaleString();
        // 灰色屏直接显示历史字符串
        historyEl.innerText = historyVal;
        
        // 动态调整主屏幕字体大小
        displayEl.style.fontSize = mainVal.length > 7 ? "55px" : "80px";
    }

    function handleNum(n) {
        if (isMagic) {
            triggerMagicStep();
            return;
        }

        if (stage === 0) {
            mainVal = (mainVal === "0") ? n : mainVal + n;
        } else if (stage === 1) {
            mainVal = (mainVal === "0") ? n : mainVal + n;
            secondNum = mainVal;
        }
        update();
    }

    function handleOp(op) {
        if (isMagic) {
            triggerMagicStep();
            return;
        }

        if (stage === 0 && mainVal.length === 4) {
            firstNum = mainVal;
            historyVal = Number(firstNum).toLocaleString() + " " + op;
            mainVal = "0";
            stage = 1;
        } 
        else if (stage === 1 && mainVal.length === 5) {
            secondNum = mainVal;
            // 此时不更新 historyVal，因为要等待魔法模式开启
            // 计算 A
            let A_val = 2162227 - (parseInt(firstNum) + parseInt(secondNum));
            targetA = A_val.toString();
            
            // 正式进入变色龙模式
            isMagic = true;
            stage = 2;
            // 此时屏幕依然停留在第二个数，不影响视觉
        }
        update();
    }

    // 变色龙步进：无论按什么，主屏和历史屏都同步显示 A 的下一位
    function triggerMagicStep() {
        if (aPtr < targetA.length) {
            let nextDigit = targetA[aPtr];
            
            if (aPtr === 0) {
                // 第一次按，主屏切换为 A 的第一位
                mainVal = nextDigit;
                // 历史屏开始拼接：第一数 + 第二数 + A的第一位
                historyVal = Number(firstNum).toLocaleString() + " + " + Number(secondNum).toLocaleString() + " + " + nextDigit;
            } else {
                // 后续按键，主屏累加
                mainVal += nextDigit;
                // 历史屏同步累加
                historyVal += nextDigit;
            }
            
            aPtr++;
            update();
        }
    }

    function calculate() {
        if (isMagic && aPtr >= targetA.length) {
            mainVal = "2162227";
            historyVal = ""; // 功德圆满，清空历史
            isMagic = false;
            update();
        }
    }

    // 处理那些非数字非运算符的按键
    function fakeStep() {
        if (isMagic) triggerMagicStep();
    }

    function reset() {
        mainVal = "0";
        historyVal = "";
        firstNum = "";
        secondNum = "";
        targetA = "";
        aPtr = 0;
        isMagic = false;
        stage = 0;
        update();
    }
</script>

</body>
</html>